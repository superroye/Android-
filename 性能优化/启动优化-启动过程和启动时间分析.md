### 前言

启动优化，需要有一个整体的思路。其工作略分为三部曲，1、启动过程分析 2、效益评估 3、实施优化。本文介绍启动过程分析，启动优化前提就是分析好前期工作，这样才不会走弯路，而且优化前后也需要对比启动时间，才能检验优化成果，这样，才敢说是科学的方法。



### 启动过程分析

#### 手段和工具

android应用启动过程分析，基本有以下几种手段和工具。

- android studio profile

  能实时跟踪所有线程的方法Trace，有很好的IDE分析工具分析某个方法的执行时间，只需要打开record/stop按钮，就能监控某个时间片的线程栈（也能监控网络和内存情况）。监控app启动过程，需要在setting里面设置一些选项。

- Debug类手动跟踪

  使用Debug.startMethodTracing()方法，能够详细的记录启动过程中的所有线程栈（设置代码的启动和终止点），自动保存成一个文件，然后提取出来在IDE上分析。

- 写日志

  trace功能虽然好用，然后性能开销很大，显示的执行时间会有比较大的增加。比较适合做卡顿分析，启动时间分析时间不准会很影响分析结果。写log是一个好的选择，因为开销小，方法执行的时间会比较准确。启动过程中组件，service的执行，需要打印较为详细的log，包含进程ID，线程ID，类名和行数，执行的代码描述等等。这样才能分析出，主线程以及子线程的大致的方法逻辑执行情况。这样，方便我们定位到耗时的地方。



#### 常用技巧和深坑

从准确性来讲，最好还是根据写log来分析执行时间，尽管这过程是枯燥的，而且非常繁琐，还需要不断重复的去观察分析。

- 观察时间戳

  一条完整的log，需要包含时间，进程，线程，类名，行数和描述这些，这样能清晰的看到整个app启动过程，尽管还是枯燥的，想像一下把app看作一台跑车，从点火到引擎开启，通电，操作盘指示灯亮，到车开始震动啥的，还是挺有意思的。而log相当于代替你启动车的视角，听觉，触觉和嗅觉感受到的具象相应的文字描述。

  从经验来看，启动过程中如果没阻塞的话，特别是不阻塞主线程的话，log是连贯的（前提是有详细的log），也就是普遍是上一个log的时间戳跟下一个，比如不超过10毫秒（具体看自己的log情况），如果偶尔有一条log跨度是200毫秒（甚至500），那此时执行的方法可能会有问题，可以优化掉。

- 观察同时执行的线程

  主线程卡住，还不一定是该方法执行的很慢，还可能是IO问题，网络问题，或者CPU资源紧张，或是主线程等待子线程结果，或是内存满了引发GC等等，这要具体分析和逐一排除。

- 注意关键的节点

  application的创建，dex加载，aroute加载，友盟bugly初始化，matrix初始化，各种组件初始化，服务类的初始化，闪屏的oncreate/onresume, 首页的oncreate/onresume/onWindowFocusChange，这些关键的节点也要重点关注。
  
- 理解启动时间

  app启动时间，不仅包含application的初始化，还包含闪屏，首页的初始化，所以完整的时间是从application /oncreate --> Splash --> Home（onWindowFocusChange(true)）。
  
  

基本上掌握了这些，就能知道你的app启动，到底是组件耗时？重复的组件初始化？还是什么地方阻塞了主线程？还是首页UI内容太多？还是IO瓶颈？